<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images — SpaTopic_inference • SpaTopic</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images — SpaTopic_inference"><meta name="description" content="This is the main function of 'SpaTopic', implementing a Collapsed Gibbs
Sampling algorithm to learn topics, which referred to different tissue microenvironments,
across multiple multiplexed tissue images.
The function takes cell labels and coordinates on tissue images as input,
and returns the inferred topic labels for every cell, as well as topic contents, a distribution
over celltypes.
The function recovers spatial tissue architectures across images,
as well as indicating cell-cell interactions in each domain."><meta property="og:description" content="This is the main function of 'SpaTopic', implementing a Collapsed Gibbs
Sampling algorithm to learn topics, which referred to different tissue microenvironments,
across multiple multiplexed tissue images.
The function takes cell labels and coordinates on tissue images as input,
and returns the inferred topic labels for every cell, as well as topic contents, a distribution
over celltypes.
The function recovers spatial tissue architectures across images,
as well as indicating cell-cell interactions in each domain."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SpaTopic</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/SpaTopic.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Intro_SpaTopic.html">SpaTopic Basics</a></li>
    <li><a class="dropdown-item" href="../articles/Model_Selection.html">Model Selection</a></li>
    <li><a class="dropdown-item" href="../articles/spleen_analysis.html">Analysis across Multiple Images</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/xiyupeng/SpaTopic/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images</h1>
      <small class="dont-index">Source: <a href="https://github.com/xiyupeng/SpaTopic/blob/HEAD/R/Gibbs_sampler.R"><code>R/Gibbs_sampler.R</code></a></small>
      <div class="d-none name"><code>SpaTopic_inference.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This is the main function of 'SpaTopic', implementing a Collapsed Gibbs
Sampling algorithm to learn topics, which referred to different tissue microenvironments,
across multiple multiplexed tissue images.
The function takes cell labels and coordinates on tissue images as input,
and returns the inferred topic labels for every cell, as well as topic contents, a distribution
over celltypes.
The function recovers spatial tissue architectures across images,
as well as indicating cell-cell interactions in each domain.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">SpaTopic_inference</span><span class="op">(</span></span>
<span>  <span class="va">tissue</span>,</span>
<span>  <span class="va">ntopics</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  region_radius <span class="op">=</span> <span class="fl">400</span>,</span>
<span>  kneigh <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  npoints_selected <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ini_LDA <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ninit <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  niter_init <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  beta <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  trace <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  niter <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  display_progress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  z_cellsize <span class="op">=</span> <span class="va">region_radius</span> <span class="op">*</span> <span class="fl">2</span>,</span>
<span>  do.parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n.cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  axis <span class="op">=</span> <span class="st">"2D"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-tissue">tissue<a class="anchor" aria-label="anchor" href="#arg-tissue"></a></dt>
<dd><p>(Required). A data frame or a list of data frames. One for each image.
Each row represent a cell with its image ID, X, Y coordinates on the image, celltype,
with column names (image, X, Y, type), respectively. For 3D tissue images, you may add
either a 'Z' column (preferred) or 'Y2' column (legacy support) for the third dimension.</p></dd>


<dt id="arg-ntopics">ntopics<a class="anchor" aria-label="anchor" href="#arg-ntopics"></a></dt>
<dd><p>(Required). Number of topics. Topics will be obtained as distributions
of cell types.</p></dd>


<dt id="arg-sigma">sigma<a class="anchor" aria-label="anchor" href="#arg-sigma"></a></dt>
<dd><p>Default is 50. The lengthscale of the Nearest-neighbor Exponential Kernel.
Sigma controls the strength of decay of correlation with distance in the kernel function.
Please check the paper for more information.
Need to be adjusted based on the image resolution</p></dd>


<dt id="arg-region-radius">region_radius<a class="anchor" aria-label="anchor" href="#arg-region-radius"></a></dt>
<dd><p>Default is 400. The radius for each grid square when
sampling region centers for each image.
Need to be adjusted based on the image resolution and pattern complexity.</p></dd>


<dt id="arg-kneigh">kneigh<a class="anchor" aria-label="anchor" href="#arg-kneigh"></a></dt>
<dd><p>Default is 5. Only consider the top 5 closest region centers for each cell.</p></dd>


<dt id="arg-npoints-selected">npoints_selected<a class="anchor" aria-label="anchor" href="#arg-npoints-selected"></a></dt>
<dd><p>Default is 1. Number of points sampled for each grid square
when sampling region centers for each image. Used with <code>region_radius</code>.</p></dd>


<dt id="arg-ini-lda">ini_LDA<a class="anchor" aria-label="anchor" href="#arg-ini-lda"></a></dt>
<dd><p>Default is TRUE. Use warm start strategy for initialization and choose the best one
to continue. If 0, it simply uses the first initialization.</p></dd>


<dt id="arg-ninit">ninit<a class="anchor" aria-label="anchor" href="#arg-ninit"></a></dt>
<dd><p>Default is 10. Number of initialization.
Only retain the initialization with the highest log likelihood (perplexity).</p></dd>


<dt id="arg-niter-init">niter_init<a class="anchor" aria-label="anchor" href="#arg-niter-init"></a></dt>
<dd><p>Default is 100. Warm start with 100 iterations in the Gibbs sampling
during initialization.</p></dd>


<dt id="arg-beta">beta<a class="anchor" aria-label="anchor" href="#arg-beta"></a></dt>
<dd><p>Default is 0.05. A hyperparameter to control the sparsity of topic content
(topic-celltype) matrix <code>Beta</code>. A smaller value introduces more sparse in <code>Beta</code>.</p></dd>


<dt id="arg-alpha">alpha<a class="anchor" aria-label="anchor" href="#arg-alpha"></a></dt>
<dd><p>Default is 0.01. A hyperparameter to control the sparsity of document (region) content
(region-topic) matrix <code>Theta</code>. For our application, we keep it
very small for the sparsity in <code>Theta</code>.</p></dd>


<dt id="arg-trace">trace<a class="anchor" aria-label="anchor" href="#arg-trace"></a></dt>
<dd><p>Default is FALSE. Compute and save log likelihood, <code>Ndk</code>, <code>Nwk</code>
for every posterior samples. Useful when you want to use DIC to select number of
topics, but it is time consuming to compute the likelihood for every posterior samples.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Default is 123. Random seed.</p></dd>


<dt id="arg-thin">thin<a class="anchor" aria-label="anchor" href="#arg-thin"></a></dt>
<dd><p>Default is 20. Key parameter in Gibbs sampling.
Collect a posterior sample for every thin=20 iterations.</p></dd>


<dt id="arg-burnin">burnin<a class="anchor" aria-label="anchor" href="#arg-burnin"></a></dt>
<dd><p>Default is 1000. Key parameter in Gibbs sampling.
Start to collect posterior samples after 1000 iterations. You may increase
the number of iterations for burn-in for highly complex tissue images.</p></dd>


<dt id="arg-niter">niter<a class="anchor" aria-label="anchor" href="#arg-niter"></a></dt>
<dd><p>Default is 200. Key parameter in Gibbs sampling.
Number of posterior samples collected for model inference.</p></dd>


<dt id="arg-display-progress">display_progress<a class="anchor" aria-label="anchor" href="#arg-display-progress"></a></dt>
<dd><p>Default is TRUE. Display the progress bar.</p></dd>


<dt id="arg-z-cellsize">z_cellsize<a class="anchor" aria-label="anchor" href="#arg-z-cellsize"></a></dt>
<dd><p>Default is region_radius*2. The thickness of each Z slice when
performing 3D stratified sampling. Only used when axis = "3D". Controls the
Z-dimension binning resolution for region center selection in 3D tissue images.
Need to be adjusted based on the tissue thickness and Z-resolution.</p></dd>


<dt id="arg-do-parallel">do.parallel<a class="anchor" aria-label="anchor" href="#arg-do-parallel"></a></dt>
<dd><p>Default is FALSE. Use parallel computing through R package <code>foreach</code>.</p></dd>


<dt id="arg-n-cores">n.cores<a class="anchor" aria-label="anchor" href="#arg-n-cores"></a></dt>
<dd><p>Default is 1. Number of cores used in parallel computing.</p></dd>


<dt id="arg-axis">axis<a class="anchor" aria-label="anchor" href="#arg-axis"></a></dt>
<dd><p>Default is "2D". You may switch to "3D" for 3D tissue images.
However, the model inference for 3D tissue is still under test.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Return a <code><a href="SpaTopic-class.html">SpaTopic-class</a></code> object. A list of outputs from Gibbs sampling.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="SpaTopic-class.html">SpaTopic-class</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## tissue is a data frame containing cellular information from one image or</span></span></span>
<span class="r-in"><span><span class="co">## multiple data frames from multiple images.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lung5"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## NOT RUN, it takes about 90s</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE</span>
<span class="r-in"><span><span class="co">#gibbs.res&lt;-SpaTopic_inference(lung5, ntopics = 7,</span></span></span>
<span class="r-in"><span><span class="co">#                               sigma = 50, region_radius = 400)</span></span></span>
<span class="r-in"><span>                             </span></span>
<span class="r-in"><span>                              </span></span>
<span class="r-in"><span><span class="co">## generate a fake image 2 and make an example for multiple images</span></span></span>
<span class="r-in"><span><span class="co">## NOT RUN</span></span></span>
<span class="r-in"><span><span class="co">#lung6&lt;-lung5</span></span></span>
<span class="r-in"><span><span class="co">#lung6$image&lt;-"image2"  ## The image ID of two images should be different</span></span></span>
<span class="r-in"><span><span class="co">#gibbs.res&lt;-SpaTopic_inference(list(A = lung5, B = lung6), </span></span></span>
<span class="r-in"><span><span class="co">#                 ntopics = 7, sigma = 50, region_radius = 400) </span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xiyu Peng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

