<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Model Selection • SpaTopic</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model Selection">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SpaTopic</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/SpaTopic.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Intro_SpaTopic.html">SpaTopic Basics</a></li>
    <li><a class="dropdown-item" href="../articles/Model_Selection.html">Model Selection</a></li>
    <li><a class="dropdown-item" href="../articles/spleen_analysis.html">Analysis across Multiple Images</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/xiyupeng/SpaTopic/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Model Selection</h1>
                        <h4 data-toc-skip class="author">Xiyu Peng</h4>
            
            <h4 data-toc-skip class="date">2025-04-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xiyupeng/SpaTopic/blob/HEAD/vignettes/articles/Model_Selection.Rmd"><code>vignettes/articles/Model_Selection.Rmd</code></a></small>
      <div class="d-none name"><code>Model_Selection.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, I will introduce how to do model selection and tune
parameters when applied <code>SpaTopic</code> to your own imaging
dataset.</p>
<div class="section level2">
<h2 id="set-up">Set-up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h2>
<p>Again, we use the lung cancer image to illustrate how to use
<code>SpaTopic</code>. The data object here can be download from <a href="https://drive.google.com/drive/folders/1_mJUjzQXWgUZlwUaLq0HKxX-aqgiQ8eD?usp=sharing" class="external-link">here</a>,
with original public resources available on the <a href="https://nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/nsclc-ffpe-dataset/" class="external-link">nanostring
website</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## We use Seurat v5 package to visualize the results.</span></span>
<span><span class="co">## If you still use Seurat v4, you will have the error</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>;<span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Seurat"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] '5.3.0'</span></span>
<span><span class="co">## Load the Seurat object for the image</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"~/Documents/Research/github/SpaTopic_data/nanostring_example.rdata"</span><span class="op">)</span></span>
<span><span class="co">## for large dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">1e9</span><span class="op">)</span></span></code></pre></div>
<p>Like before, we prepare the dataset as the input of the
algorithm.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xiyupeng/SpaTopic">SpaTopic</a></span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/Seurat5obj_to_SpaTopic.html">Seurat5obj_to_SpaTopic</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">nano.obj</span>, group.by <span class="op">=</span> <span class="st">"predicted.annotation.l1"</span>, image <span class="op">=</span> <span class="st">"image1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [16:41:56] [SpaTopic INFO] Successfully extracted 100149 cells with coordinates and annotations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span><span class="co">#&gt;      image        X        Y           type</span></span>
<span><span class="co">#&gt; 1_1 image1 4215.889 158847.7      Dendritic</span></span>
<span><span class="co">#&gt; 2_1 image1 6092.889 158834.7     Macrophage</span></span>
<span><span class="co">#&gt; 3_1 image1 7214.889 158843.7 Neuroendocrine</span></span>
<span><span class="co">#&gt; 4_1 image1 7418.889 158813.7     Macrophage</span></span>
<span><span class="co">#&gt; 5_1 image1 7446.889 158845.7     Macrophage</span></span>
<span><span class="co">#&gt; 6_1 image1 3254.889 158838.7          CD4 T</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="convergence-of-gibbs-sampling">Convergence of Gibbs Sampling<a class="anchor" aria-label="anchor" href="#convergence-of-gibbs-sampling"></a>
</h2>
<p>This time we will track and keep all output from Gibbs sampling
algorithm with <code>trace = TRUE</code>. Here we also reset the
parameters for Gibbs sampling (thin = 20, burnin = 0, niter = 200): we
run Gibbs sampling train in first 4000 iterations and take 200 posterior
samples every 20 iterations.</p>
<p><strong>Important Note for running</strong></p>
<p>With <code>trace = TRUE</code>, we will compute the log likelihood
for every posterior samples. However, it takes time on large dataset and
we recommend tuning your parameters on one or a few images instead of
directly on the whole big image datasets.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## it take about 3-4min to run </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xiyupeng/SpaTopic">SpaTopic</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">gibbs.res</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SpaTopic_inference.html">SpaTopic_inference</a></span><span class="op">(</span><span class="va">dataset</span>, ntopics <span class="op">=</span> <span class="fl">7</span>, sigma <span class="op">=</span> <span class="fl">50</span>, </span>
<span>                                          region_radius <span class="op">=</span> <span class="fl">400</span>,trace <span class="op">=</span> <span class="cn">TRUE</span>, thin <span class="op">=</span> <span class="fl">20</span>, burnin <span class="op">=</span> <span class="fl">0</span>, niter <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [16:41:56] [SpaTopic INFO] Number of cells per image: 100149</span></span>
<span><span class="co">#&gt; [16:41:56] [SpaTopic INFO] Start initialization...</span></span>
<span><span class="co">#&gt; [16:41:56] [SpaTopic INFO] Number of Initializations: 10</span></span>
<span><span class="co">#&gt; [16:42:16] [SpaTopic RESULT] Min perplexity during initialization: 11.6302</span></span>
<span><span class="co">#&gt; [16:42:16] [SpaTopic INFO] Number of region centers selected: 971</span></span>
<span><span class="co">#&gt; [16:42:16] [SpaTopic INFO] Average number of cells per region: 103.14</span></span>
<span><span class="co">#&gt; [16:42:16] [SpaTopic PROGRESS] Initialization complete. Starting Gibbs sampling...</span></span>
<span><span class="co">#&gt; [16:45:10] [SpaTopic COMPLETE] Gibbs sampling completed successfully</span></span>
<span><span class="co">#&gt; [16:45:10] [SpaTopic RESULT] Final model perplexity: 11.3127</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt; 193.209   0.589 194.050</span></span></code></pre></div>
<p>Now we can plot the log likelihood across different iterations.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">### plot the log likelihood of the method</span></span>
<span><span class="va">trace_result</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>loglike <span class="op">=</span> <span class="va">gibbs.res</span><span class="op">$</span><span class="va">loglike.trace</span>, iteration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4000</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">trace_result</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">loglike</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1000</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2000</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Model_Selection_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>Based on the plot, we found the algorithm converges around 1000
iterations. Thus it is safe to set <code>burnin = 1000</code> (by
default) for this dataset, starting taking posterior samples after 1000
iterations. Or a more conserved choice is <code>burnin = 2000</code>,
which is used for the analysis results in the paper.</p>
<p>With <code>trace = TRUE</code>, we also output DIC for model
selection.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gibbs.res</span><span class="op">)</span></span>
<span><span class="co">#&gt; SpaTopic Results</span></span>
<span><span class="co">#&gt; ----------------</span></span>
<span><span class="co">#&gt; Number of topics: 7 </span></span>
<span><span class="co">#&gt; Perplexity: 11.31266 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; DIC: 998805.7 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Topic Content(Topic distribution across cell types):</span></span>
<span><span class="co">#&gt;                                 topic1       topic2       topic3      topic4</span></span>
<span><span class="co">#&gt; Alveolar Epithelial Type 1 0.034183965 6.550357e-03 4.691796e-06 0.028458815</span></span>
<span><span class="co">#&gt; Alveolar Epithelial Type 2 0.025964979 3.606789e-02 4.691796e-06 0.017168270</span></span>
<span><span class="co">#&gt; Artery                     0.007522377 2.640208e-06 4.691796e-06 0.001841738</span></span>
<span><span class="co">#&gt; B                          0.019249466 1.610527e-04 3.496373e-01 0.015584528</span></span>
<span><span class="co">#&gt; Basal                      0.024461506 7.790225e-01 2.069082e-03 0.087874670</span></span>
<span><span class="co">#&gt;                                  topic5       topic6      topic7</span></span>
<span><span class="co">#&gt; Alveolar Epithelial Type 1 3.094079e-06 6.029981e-06 0.004772139</span></span>
<span><span class="co">#&gt; Alveolar Epithelial Type 2 1.268572e-04 6.029981e-06 0.006764303</span></span>
<span><span class="co">#&gt; Artery                     6.438777e-03 1.797537e-02 0.006522828</span></span>
<span><span class="co">#&gt; B                          1.695864e-02 6.397810e-03 0.022822353</span></span>
<span><span class="co">#&gt; Basal                      5.696199e-03 6.029981e-06 0.006583197</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use $Z.trace for posterior probabilities of topic assignments for each cell</span></span>
<span><span class="co">#&gt; Use $cell_topics for final topic assignments for each cell</span></span>
<span><span class="co">#&gt; Use $parameters for accessing model parameters</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="number-of-topics">Number of Topics<a class="anchor" aria-label="anchor" href="#number-of-topics"></a>
</h2>
<p>Here, we will illustrate how to use DIC to select number of topics.
We first run the model under different number of topics, each collecting
100 posterior samples after 1000 burnin iterations. For higher number of
topics, it may take longer time to converge, thus we set
<code>burnin = 2000</code> instead of the default.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## PRE-RUN the result</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">topic</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">gibbs.res</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SpaTopic_inference.html">SpaTopic_inference</a></span><span class="op">(</span><span class="va">dataset</span>, ntopics <span class="op">=</span> <span class="va">topic</span>, sigma <span class="op">=</span> <span class="fl">50</span>, region_radius <span class="op">=</span> <span class="fl">400</span>, trace <span class="op">=</span> <span class="cn">TRUE</span>, thin <span class="op">=</span> <span class="fl">20</span>, burnin <span class="op">=</span> <span class="fl">2000</span>, niter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">filename</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"~/Documents/Research/github/SpaTopic_data/nanostring_niter100_K"</span>,<span class="va">topic</span>,<span class="st">".rds"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">gibbs.res</span>, file <span class="op">=</span> <span class="va">filename</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract result object</span></span>
<span><span class="va">result</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">topic</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">filename</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"~/Documents/Research/github/SpaTopic_data/nanostring_niter100_K"</span>,<span class="va">topic</span>,<span class="st">".rds"</span><span class="op">)</span></span>
<span>  <span class="va">result</span><span class="op">[[</span><span class="va">topic</span><span class="op">]</span><span class="op">]</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, we plot DIC for each selected number of topics.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DICs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">DIC</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">DIC_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Topics <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">9</span>,</span>
<span>  DIC <span class="op">=</span> <span class="va">DICs</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">DIC_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Topics</span>, y <span class="op">=</span> <span class="va">DIC</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept  <span class="op">=</span> <span class="fl">7</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Model_Selection_files/figure-html/DIC-1.png" width="480"></p>
<p>It may be time consuming to compute DIC. You may also check the
perplexity of the last posterior if working on large dataset. Just like
likelihood, as the number of topics increases, the model likelihood
generally improves, leading to a decrease in perplexity. However, a
stable perplexity score can indicate an optimal number of topics,
providing a balance between model complexity and fit.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Perplexity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">result</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">Perplexity</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">perx_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Topics <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">9</span>,</span>
<span>  Perplexity <span class="op">=</span> <span class="va">Perplexity</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">perx_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Topics</span>, y <span class="op">=</span> <span class="va">Perplexity</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept  <span class="op">=</span> <span class="fl">7</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Model_Selection_files/figure-html/perplexity-1.png" width="480"></p>
<p>Based on our model selection analysis, <strong>k = 7 topics</strong>
provides an optimal balance between model fit and interpretability. This
provides biologically meaningful spatial topics that align well with
known tissue structures and cellular interactions in the tumor
microenvironment. Choosing number of topics (clusters) sometimes is
subjective since there is often no real number of clusters in real
biological dataset.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Gibbs sampling for SpaTopic</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">gibbs.res</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/SpaTopic_inference.html">SpaTopic_inference</a></span><span class="op">(</span><span class="va">dataset</span>, ntopics <span class="op">=</span> <span class="fl">7</span>, sigma <span class="op">=</span> <span class="fl">50</span>, region_radius <span class="op">=</span> <span class="fl">400</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [16:45:11] [SpaTopic INFO] Number of cells per image: 100149</span></span>
<span><span class="co">#&gt; [16:45:11] [SpaTopic INFO] Start initialization...</span></span>
<span><span class="co">#&gt; [16:45:11] [SpaTopic INFO] Number of Initializations: 10</span></span>
<span><span class="co">#&gt; [16:45:31] [SpaTopic RESULT] Min perplexity during initialization: 11.6302</span></span>
<span><span class="co">#&gt; [16:45:31] [SpaTopic INFO] Number of region centers selected: 971</span></span>
<span><span class="co">#&gt; [16:45:31] [SpaTopic INFO] Average number of cells per region: 103.14</span></span>
<span><span class="co">#&gt; [16:45:31] [SpaTopic PROGRESS] Initialization complete. Starting Gibbs sampling...</span></span>
<span><span class="co">#&gt; [16:46:09] [SpaTopic COMPLETE] Gibbs sampling completed successfully</span></span>
<span><span class="co">#&gt; [16:46:09] [SpaTopic RESULT] Final model perplexity: 11.3156</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  57.310   0.187  57.568</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## In the new version of SpaTopic, the final topic assignments is in cell topics.</span></span>
<span><span class="va">nano.obj</span><span class="op">$</span><span class="va">Topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gibbs.res</span><span class="op">$</span><span class="va">cell_topics</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">palatte</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#0000FFFF"</span>,<span class="st">"#FF0000FF"</span>,<span class="st">"#00FF00FF"</span>,<span class="st">"#009FFFFF"</span>,<span class="st">"#ff00b7fa"</span>,<span class="st">"#005300FF"</span>,<span class="st">"#FFD300FF"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ImageDimPlot.html" class="external-link">ImageDimPlot</a></span><span class="op">(</span><span class="va">nano.obj</span>, fov <span class="op">=</span> <span class="st">"lung5.rep1"</span>, group.by <span class="op">=</span> <span class="st">"Topic"</span>, axes <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                           dark.background <span class="op">=</span> <span class="cn">T</span>,cols <span class="op">=</span> <span class="va">palatte</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Topic"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="Model_Selection_files/figure-html/topics-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="parameter-choice">Parameter Choice<a class="anchor" aria-label="anchor" href="#parameter-choice"></a>
</h2>
<p>When running SpaTopic, both <code>sigma</code> and
<code>region_radius</code> should be set based on image resolution and
tissue complexity:</p>
<ul>
<li><p>For whole-slide imaging applications, select
<code>region_radius</code> to include at least 100 cells per region on
average. Note that different imaging platforms may report spatial
coordinates in either pixels or microns, so adjust parameters
accordingly.</p></li>
<li><p>The <code>sigma</code> parameter should be tuned in conjunction
with <code>region_radius</code>. Empirically, we’ve found that setting
<code>sigma</code> to approximately the square root of
<code>region_radius</code> works well as a starting point for parameter
tuning.</p></li>
<li><p>Small <code>sigma</code> and <code>region_radius</code> will
focus on more local structure while ignoring global structure.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Xiyu Peng.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
